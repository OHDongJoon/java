-- [IV] 쇼핑몰 설계
DROP TABLE CART;
DROP TABLE ORDER_DETAIL;
DROP TABLE ORDERS;
DROP TABLE MEMBER;
DROP TABLE PRODUCT; -- 테이블 삭제가 안 되면 참조되는 테이블이 있는 경우
                    -- 무시하고 삭제하고자 하면 CASCADE CONSTRAINTS 추가
CREATE TABLE MEMBER(
    mID VARCHAR2(20) PRIMARY KEY,
    mNAME VARCHAR2(50),
    mADDR VARCHAR2(255),
    mTEL VARCHAR2(30),    
    mMAIL VARCHAR2(40));
CREATE TABLE PRODUCT(
    pCODE VARCHAR2(5) PRIMARY KEY,
    pNAME VARCHAR2(50),
    PRICE NUMBER(6),
    pSTOCK NUMBER(3)
);
DROP SEQUENCE CART_SEQ;
CREATE SEQUENCE CART_SEQ MAXVALUE 999999999 NOCACHE NOCYCLE;
CREATE TABLE CART(
    cNO NUMBER(9) PRIMARY KEY,
    mID VARCHAR2(20) REFERENCES MEMBER(mID),
    pCODE VARCHAR2(5) REFERENCES PRODUCT(pCODE),
    QTY NUMBER(3),
    COST NUMBER(9));-- 밑에 추가해도 됨. FOREIGN KEY(mID) REFERENCES MEMBER(mID)
DROP SEQUENCE ORDERS_SEQ;
CREATE SEQUENCE ORDERS_SEQ MAXVALUE 99999 NOCACHE;
CREATE TABLE ORDERS(
    oNO NUMBER(11) PRIMARY KEY,
    mID VARCHAR2(10) REFERENCES MEMBER(mID),
    oADDR VARCHAR2(255),
    oTEL VARCHAR2(30),
    oDATE DATE);
DROP SEQUENCE ORDER_DETAIL_SEQ;
CREATE SEQUENCE ORDER_DETAIL_SEQ MAXVALUE 999999999 NOCYCLE NOCACHE;
CREATE TABLE ORDER_DETAIL(
    odNO  NUMBER(9) PRIMARY KEY,
    oNO   NUMBER REFERENCES ORDERS(oNO),
    pCODE VARCHAR2(5) REFERENCES PRODUCT(pCODE),
    QTY   NUMBER(3),
    COST  NUMBER(9));
SELECT * FROM MEMBER;
SELECT * FROM PRODUCT;
SELECT * FROM CART;
SELECT * FROM ORDERS;
SELECT * FROM ORDER_DETAIL;
INSERT INTO MEMBER VALUES ('abc','홍길동','서울 강남구','010-1111-1111','hong@hong.com');
INSERT INTO MEMBER VALUES ('def','전투왕','경기도 수원시','031-222-2222','jun@hong.com');
SELECT * FROM MEMBER;
INSERT INTO PRODUCT VALUES ('A1', '맥주', 3000, 100);
INSERT INTO PRODUCT VALUES ('A2', '소주', 2000, 90);
INSERT INTO PRODUCT VALUES ('B1', '땅콩', 3500, 90);
INSERT INTO PRODUCT VALUES ('B2', '오징어', 5000, 80);
INSERT INTO PRODUCT VALUES ('C1', '기저귀', 7000, 150);
SELECT * FROM PRODUCT;

-- 주문번호 가져오기 (22041900001)
SELECT TO_CHAR(SYSDATE, 'YYMMDD') FROM DUAL; -- 220419
SELECT TRIM(TO_CHAR(2, '00000')) FROM DUAL;  -- " 00002"
SELECT TO_CHAR(SYSDATE, 'YYMMDD')||TRIM(TO_CHAR(ORDERS_SEQ.NEXTVAL,'00000')) FROM DUAL;
DROP SEQUENCE ORDERS_SEQ;
CREATE SEQUENCE ORDERS_SEQ MAXVALUE 99999 NOCACHE NOCYCLE;

INSERT INTO ORDERS VALUES ( 
    TO_CHAR(SYSDATE, 'YYMMDD')||TRIM(TO_CHAR(ORDERS_SEQ.NEXTVAL,'00000')),
    'abc','서울시 강남구', '010-1111-1111',SYSDATE);
INSERT INTO ORDERS VALUES ( 
    TO_CHAR(SYSDATE, 'YYMMDD')||TRIM(TO_CHAR(ORDERS_SEQ.NEXTVAL,'00000')),
    'def','서울시 서대문구', '010-2222-2222',SYSDATE);
INSERT INTO ORDERS VALUES ( 
    TO_CHAR(SYSDATE, 'YYMMDD')||TRIM(TO_CHAR(ORDERS_SEQ.NEXTVAL,'00000')),
    'abc','경기도 과천', '010-3333-3333',SYSDATE);
SELECT * FROM ORDERS;
SELECT * FROM ORDER_DETAIL;
INSERT INTO ORDER_DETAIL VALUES
    (ORDER_DETAIL_SEQ.NEXTVAL, 22041900001, 'A1', 3, (SELECT PRICE FROM PRODUCT WHERE pCODE='A1')*3);
    
UPDATE PRODUCT SET pSTOCK = pSTOCK-3 WHERE pCODE='A1'; -- 재고 수정
INSERT INTO ORDER_DETAIL VALUES
    (ORDER_DETAIL_SEQ.NEXTVAL, 22041900001, 'B1', 1, (SELECT PRICE FROM PRODUCT WHERE pCODE='B1')*1);
UPDATE PRODUCT SET pSTOCK = pSTOCK-1 WHERE pCODE='B1';
INSERT INTO ORDER_DETAIL VALUES
    (ORDER_DETAIL_SEQ.NEXTVAL, 22041900001, 'A2', 2, (SELECT PRICE FROM PRODUCT WHERE pCODE='A2')*2);
UPDATE PRODUCT SET pSTOCK = pSTOCK-2 WHERE pCODE='A2';

INSERT INTO ORDER_DETAIL VALUES
    (ORDER_DETAIL_SEQ.NEXTVAL, 22041900001, 'B2', 1, (SELECT PRICE FROM PRODUCT WHERE pCODE='B2')*1);
UPDATE PRODUCT SET pSTOCK = pSTOCK-1 WHERE pCODE='B2';
SELECT * FROM ORDER_DETAIL;
INSERT INTO ORDER_DETAIL VALUES
    (ORDER_DETAIL_SEQ.NEXTVAL, 22041900002, 'A2', 2, (SELECT PRICE FROM PRODUCT WHERE pCODE='A2')*2);
UPDATE PRODUCT SET pSTOCK = pSTOCK-2 WHERE pCODE='A2';
INSERT INTO ORDER_DETAIL VALUES
    (ORDER_DETAIL_SEQ.NEXTVAL, 22041900002, 'B2', 1, (SELECT PRICE FROM PRODUCT WHERE pCODE='B2')*1);
UPDATE PRODUCT SET pSTOCK = pSTOCK-1 WHERE pCODE='B2';
INSERT INTO ORDER_DETAIL VALUES
    (ORDER_DETAIL_SEQ.NEXTVAL, 22041900002, 'C1', 1, (SELECT PRICE FROM PRODUCT WHERE pCODE='C1')*1);
UPDATE PRODUCT SET pSTOCK = pSTOCK-1 WHERE pCODE='C1';
SELECT * FROM ORDER_DETAIL;  
INSERT INTO ORDER_DETAIL VALUES
    (ORDER_DETAIL_SEQ.NEXTVAL, 22041900003, 'A1', 2, (SELECT PRICE FROM PRODUCT WHERE pCODE='A1')*2);
UPDATE PRODUCT SET pSTOCK = pSTOCK-2 WHERE pCODE='A1';
INSERT INTO ORDER_DETAIL VALUES
    (ORDER_DETAIL_SEQ.NEXTVAL, 22041900003, 'B1', 1, (SELECT PRICE FROM PRODUCT WHERE pCODE='B1')*1);
UPDATE PRODUCT SET pSTOCK = pSTOCK-1 WHERE pCODE='B1';
INSERT INTO ORDER_DETAIL VALUES
    (ORDER_DETAIL_SEQ.NEXTVAL, 22041900003, 'C1', 1, (SELECT PRICE FROM PRODUCT WHERE pCODE='C1')*1);
UPDATE PRODUCT SET pSTOCK = pSTOCK-1 WHERE pCODE='C1';
SELECT * FROM ORDER_DETAIL; 
SELECT * FROM ORDERS;
SELECT * FROM PRODUCT;
SELECT * FROM MEMBER;
